<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Truth or Trap - Game Modular</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://i.imgur.com/rfp3aJA.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      text-align: center;
      padding: 20px;
    }
    #overlay {
      background-color: rgba(0, 0, 0, 0.65);
      padding: 20px;
      border-radius: 15px;
      max-width: 800px;
      margin: auto;
    }
    input, select, button {
      font-size: 16px;
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    input, select {
      width: 150px;
      text-align: center;
    }
    button {
      background-color: #28a745;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #218838;
    }
    button:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    #playersList div {
      background: #222;
      margin: 5px auto;
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      min-width: 120px;
      font-weight: bold;
    }
    #voteArea button {
      margin: 5px;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    #voteArea button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    #toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      display: none;
      z-index: 9999;
      box-shadow: 0 0 10px #000;
      transition: opacity 0.5s;
    }
    #inviteLinkArea {
      background-color: #222;
      margin: 10px auto;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      user-select: all;
      width: fit-content;
    }
    #resultArea {
      background-color: #222;
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      min-height: 80px;
      font-size: 18px;
    }
    #countdown {
      color: yellow;
      font-size: 20px;
      margin-top: 10px;
      font-weight: bold;
    }
    #progressContainer {
      width: 100%;
      background: #333;
      height: 20px;
      border-radius: 10px;
      margin-top: 10px;
    }
    #progressBar {
      width: 100%;
      height: 100%;
      background: yellow;
      border-radius: 10px;
      transition: width 1s linear;
    }
    #restartArea button {
      font-size: 18px;
      padding: 10px 20px;
      background: #ffc107;
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    @media (max-width: 768px) {
      #overlay {
        padding: 10px;
      }
      h1 {
        font-size: 22px;
      }
      input, select, button {
        width: 100%;
        font-size: 18px;
      }
      #playersList div {
        display: block;
        width: 100%;
        margin: 8px 0;
      }
      #voteArea button {
        width: 100%;
        margin: 8px 0;
        font-size: 18px;
      }
      #resultArea h2 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="overlay">
    <h1>üé≠ Monad Truth or Trap</h1>

    <div id="entryArea">
      <div>
        <label for="roundsSelect">Number of rounds:</label>
        <select id="roundsSelect">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="30" selected>30</option>
        </select>
      </div>
      <div>
        <input type="text" id="playerName" placeholder="Your name" />
        <button id="btnCreateRoom">Create Room</button>
      </div>
      <div>
        <input type="text" id="roomIDInput" placeholder="Room code" />
        <button id="btnJoinRoom">Join</button>
      </div>
    </div>

    <div id="inviteLinkArea" style="display:none" title="Click to copy" onclick="copyInviteLink()">
      üîó Invitation link: <span id="linkInvite"></span>
    </div>

    <div id="playersList"></div>

    <div id="gameArea" style="display:none">
      <h2 id="questionText"></h2>
      <div id="voteArea"></div>
      <div id="countdown"></div>
      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>
    </div>

    <div id="resultArea" style="display:none"></div>

    <div id="buttonsArea" style="display:none; margin-top: 15px;">
      <button id="btnStart">üöÄ Start Round</button>
    </div>

    <div id="restartArea" style="display:none">
      <button onclick="location.reload()">üîÑ Return to Start</button>
    </div>

    <div id="toast"></div>
    <audio id="endSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAv02neUyAXLklrx__3WrbO31OmqHSQiDk",
    authDomain: "truth-or-trap-game.firebaseapp.com",
    databaseURL: "https://truth-or-trap-game-default-rtdb.firebaseio.com",
    projectId: "truth-or-trap-game",
    storageBucket: "truth-or-trap-game.appspot.com",
    messagingSenderId: "989300391170",
    appId: "1:989300391170:web:b4ea01be707e63de29561b"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let roomID, playerName, players = {}, votes = {}, points = {}, liar = null,
      maxRounds = 30, roundNumber = 0, voteTimer = null, countdownInterval = null,
      timeLeft = 20, myVote = null, revealedLiar = null;

  const questions = [
    "Have you ever lied to a friend?",
    "Do you trust everyone here?",
    "Are you hiding a secret right now?",
    "Did you tell a lie today?",
    "Do you suspect someone here?",
    "Can you lie calmly?"
  ];

  function showToast(msg, duration=3000) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.style.display = "block";
    toast.style.opacity = "1";
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.style.display = "none", 500);
    }, duration);
  }

  function makeRoomID(len=6) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let r = "";
    for(let i=0; i<len; i++) r += chars.charAt(Math.floor(Math.random()*chars.length));
    return r;
  }

  async function createRoom() {
    playerName = document.getElementById("playerName").value.trim();
    if (!playerName) return showToast("‚ö†Ô∏è Enter your name!");
    maxRounds = parseInt(document.getElementById("roundsSelect").value);

    const tryCreate = async () => {
      roomID = makeRoomID();
      const snap = await get(ref(db, "rooms/" + roomID));
      if (snap.exists()) return tryCreate();
      players = {}; players[playerName] = true;
      points = {}; points[playerName] = 0;
      await set(ref(db, "rooms/" + roomID), {
        players, points, roundNumber:0, maxRounds, gameStarted:false, votes:{}, revealed:null
      });
      showToast("‚úÖ Room created!");
      initAfterJoin();
    };
    tryCreate();
  }

  async function joinRoom() {
    playerName = document.getElementById("playerName").value.trim();
    if (!playerName) return showToast("‚ö†Ô∏è Enter your name!");
    roomID = document.getElementById("roomIDInput").value.trim().toUpperCase();
    const snap = await get(ref(db, "rooms/" + roomID + "/players"));
    if (!snap.exists()) return showToast("‚ùå Room not found!");
    players = snap.val();
    players[playerName] = true;
    const roomSnap = await get(ref(db, "rooms/" + roomID));
    points = roomSnap.val().points || {};
    points[playerName] = points[playerName] || 0;
    await update(ref(db, "rooms/" + roomID), {players, points});
    showToast("‚úÖ Joined successfully!");
    initAfterJoin();
  }

  function initAfterJoin() {
    document.getElementById("entryArea").style.display = "none";
    document.getElementById("buttonsArea").style.display = "block";
    listenRoom();
  }

  function listenRoom() {
    onValue(ref(db, "rooms/" + roomID), (snap) => {
      const d = snap.val();
      if (!d) return;
      players = d.players || {};
      votes = d.votes || {};
      points = d.points || {};
      maxRounds = d.maxRounds || 30;
      roundNumber = d.roundNumber || 0;
      revealedLiar = d.revealed?.liar || null;
      updatePlayersList();

      const inviteEl = document.getElementById("inviteLinkArea");
      inviteEl.style.display = d.gameStarted ? "none" : "block";
      document.getElementById("linkInvite").textContent = location.href.split("#")[0] + "#" + roomID;

      if (d.gameStarted) {
        showQuestion(d.question, roundNumber);
        document.getElementById("btnStart").style.display = "none";
        showVotes();
        if (d.revealed) showResult(d.revealed);
        else clearResult();
      } else {
        document.getElementById("btnStart").style.display = roundNumber < maxRounds ? "inline-block" : "none";
        clearTimeout(voteTimer);
        clearInterval(countdownInterval);
        document.getElementById("countdown").textContent = "";
        document.getElementById("gameArea").style.display = revealedLiar ? "block" : "none";
        if (revealedLiar) showResult(d.revealed);
        else clearResult();
        myVote = null;

        if(roundNumber >= maxRounds){
          document.getElementById("restartArea").style.display = "block";
          document.getElementById("buttonsArea").style.display = "none";
          document.getElementById("gameArea").style.display = "none";
        } else {
          document.getElementById("restartArea").style.display = "none";
        }
      }
    });
  }

  function updatePlayersList() {
    const el = document.getElementById("playersList");
    el.innerHTML = "";
    for(let p in players){
      let mark = p === revealedLiar ? " üòà" : "";
      let color = p === revealedLiar ? "red" : "white";
      el.innerHTML += `<div style="color:${color}">${p}${mark} - Points: ${points[p] || 0}</div>`;
    }
  }

  async function startRound() {
    if(Object.keys(players).length < 3) {
      return showToast("‚ö†Ô∏è Need at least 3 players!");
    }
    const rn = roundNumber + 1;
    if(rn > maxRounds) return announceWinner();

    const li = Object.keys(players)[Math.floor(Math.random()*Object.keys(players).length)];
    const q = questions[Math.floor(Math.random()*questions.length)];

    await update(ref(db, "rooms/" + roomID), {
      gameStarted: true,
      roundNumber: rn,
      question: q,
      liar: li,
      votes: {},
      revealed: null,
    });
    myVote = null;
  }

  function showQuestion(q, r) {
    document.getElementById("gameArea").style.display = "block";
    document.getElementById("questionText").textContent = `üïê Round ${r}: ${q}`;
    clearResult();
  }

  function showVotes() {
    clearTimeout(voteTimer);
    clearInterval(countdownInterval);

    const v = document.getElementById("voteArea");
    v.innerHTML = "";
    for(let p in players){
      let votedMark = myVote === p ? " ‚úÖ" : "";
      v.innerHTML += `<button onclick="vote('${p}')" id="voteBtn_${p}">${p}${votedMark}</button>`;
    }

    timeLeft = 20;
    const countdown = document.getElementById("countdown");

    function tick(){
      countdown.textContent = `‚è≥ ${timeLeft} seconds left to vote`;
      document.getElementById("progressBar").style.width = (timeLeft/20*100) + "%";

      if(timeLeft <= 0){
        document.getElementById("endSound").play();
        revealLiar();
      } else {
        timeLeft--;
        countdownInterval = setTimeout(tick, 1000);
      }
    }
    tick();
  }

  async function vote(who){
    if(myVote) return;
    myVote = who;
    votes[who] = (votes[who]||0)+1;
    await set(ref(db,"rooms/"+roomID+"/votes"), votes);
    showToast("‚úÖ Voted for " + who);

    for(let p in players){
      const btn = document.getElementById("voteBtn_" + p);
      if(btn) btn.disabled = true;
    }
  }

  async function revealLiar(){
    clearTimeout(voteTimer);
    clearInterval(countdownInterval);

    const snap = await get(ref(db,"rooms/"+roomID));
    const d = snap.val();
    const v = d.votes || {};
    const liar = d.liar;
    let most = null, mx=0;
    for(let p in v){
      if(v[p]>mx){
        mx = v[p];
        most = p;
      }
    }
    const success = most === liar;
    const pts = {...d.points};
    if(success){
      for(let p in v)
        if(v[p]>0) pts[p] = (pts[p]||0)+1;
    } else {
      pts[liar] = (pts[liar]||0)+2;
    }
    const res = {liar, most, success};

    await update(ref(db,"rooms/"+roomID), {
      revealed: res,
      points: pts,
      gameStarted: false,
    });

    showResult(res);

    setTimeout(()=>{
      if(roundNumber < maxRounds){
        startRound();
      } else {
        announceWinner();
      }
    }, 5000);
  }

  function showResult(res){
    const r = document.getElementById("resultArea");
    r.style.display = "block";
    r.innerHTML = `<h2 style="color:red;">üòà The liar is: ${res.liar}</h2>
                   <p>${res.success ? "‚úÖ Successfully caught" : "‚ùå Not caught. Voted for: " + (res.most || "No one")}</p>`;
  }

  function clearResult(){
    const r = document.getElementById("resultArea");
    r.style.display = "none";
    r.innerHTML = "";
  }

  function announceWinner() {
    let mx = -1, winners = [];
    for (let p in points) {
      if (points[p] > mx) {
        mx = points[p];
        winners = [p];
      } else if (points[p] === mx) {
        winners.push(p);
      }
    }
    const resultArea = document.getElementById("resultArea");
    resultArea.style.display = "block";
    if (winners.length === 1) {
      resultArea.innerHTML = `<h2 style="color: gold;">üèÜ The winner is: ${winners[0]} with ${mx} points</h2>`;
    } else {
      resultArea.innerHTML = `<h2 style="color: gold;">üèÜ Tie between: ${winners.join(", ")} with ${mx} points</h2>`;
    }
    showToast("üèÜ Game over! Winner: " + winners.join(", ") + " with " + mx + " points", 7000);

    document.getElementById("btnStart").style.display = "none";
    document.getElementById("gameArea").style.display = "none";
    document.getElementById("restartArea").style.display = "block";
    document.getElementById("buttonsArea").style.display = "none";
  }

  function copyInviteLink(){
    const text = location.href.split("#")[0] + "#" + roomID;
    navigator.clipboard.writeText(text);
    showToast("üîó Invitation link copied!");
  }

  window.onload = () => {
    document.getElementById("btnCreateRoom").onclick = createRoom;
    document.getElementById("btnJoinRoom").onclick = joinRoom;
    document.getElementById("btnStart").onclick = startRound;
    const hash = location.hash.substring(1);
    if(hash) document.getElementById("roomIDInput").value = hash;
  };
</script>
</body>
</html>
